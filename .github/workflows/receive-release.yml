name: Receive Release

permissions:
  contents: write

on:
  repository_dispatch:
    types: [release_ready]

env:
  CARGO_TERM_COLOR: always

jobs:
  receive_release:
    name: Receive Release from Private Repo
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get release info
        id: release_info
        run: |
          TAG="${{ github.event.client_payload.tag }}"
          VERSION="${{ github.event.client_payload.version }}"

          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ æ¥æ”¶åˆ°å‘å¸ƒè¯·æ±‚: $TAG"

      - name: Download artifacts from private repository
        run: |
          TAG="${{ steps.release_info.outputs.tag }}"
          VERSION="${{ steps.release_info.outputs.version }}"

          echo "ğŸ“¥ ä»ç§æœ‰ä»“åº“ä¸‹è½½æ„å»ºäº§ç‰©..."

          # åˆ›å»ºä¸´æ—¶ç›®å½•
          mkdir -p release

          # ä¸‹è½½æ‰€æœ‰å¹³å°çš„äºŒè¿›åˆ¶æ–‡ä»¶
          PLATFORMS=("linux-x64" "macos-x64" "macos-arm64")

          for platform in "${PLATFORMS[@]}"; do
            echo "ä¸‹è½½ $platform ..."

            # logid
            curl -L -o "release/logid-${VERSION}-${platform}.tar.gz" \
              "https://github.com/DreamCats/byted-cli/releases/download/${TAG}/logid-${VERSION}-${platform}.tar.gz" || echo "âš ï¸  logid-${VERSION}-${platform}.tar.gz ä¸‹è½½å¤±è´¥"

            # lark
            curl -L -o "release/lark-${VERSION}-${platform}.tar.gz" \
              "https://github.com/DreamCats/byted-cli/releases/download/${TAG}/lark-${VERSION}-${platform}.tar.gz" || echo "âš ï¸  lark-${VERSION}-${platform}.tar.gz ä¸‹è½½å¤±è´¥"

            # ark
            curl -L -o "release/ark-${VERSION}-${platform}.tar.gz" \
              "https://github.com/DreamCats/byted-cli/releases/download/${TAG}/ark-${VERSION}-${platform}.tar.gz" || echo "âš ï¸  ark-${VERSION}-${platform}.tar.gz ä¸‹è½½å¤±è´¥"
          done

          # ä¸‹è½½ SHA256SUMS
          curl -L -o "release/SHA256SUMS" \
            "https://github.com/DreamCats/byted-cli/releases/download/${TAG}/SHA256SUMS" || echo "âš ï¸  SHA256SUMS ä¸‹è½½å¤±è´¥"

          ls -lh release/

      - name: Generate release notes
        id: release_notes
        run: |
          TAG="${{ steps.release_info.outputs.tag }}"
          VERSION="${{ steps.release_info.outputs.version }}"

          cat > release_notes.md << 'EOF'
          # ByteDance CLI å·¥å…·é›† $VERSION å‘å¸ƒ

          ## å·¥å…·åˆ—è¡¨

          ### logid - æ—¥å¿—æŸ¥è¯¢å·¥å…·
          - ğŸŒ æ”¯æŒå¤šåŒºåŸŸæŸ¥è¯¢ï¼ˆç¾åŒº/å›½é™…åŒ–/ä¸­å›½åŒºï¼‰
          - ğŸ” JWT è®¤è¯è‡ªåŠ¨ç®¡ç†
          - ğŸ” æ¶ˆæ¯è¿‡æ»¤ï¼ˆPSM å’Œè‡ªå®šä¹‰è§„åˆ™ï¼‰
          - ğŸ“‹ å¤šç§è¾“å‡ºæ ¼å¼ï¼ˆæ–‡æœ¬/JSONï¼‰

          ### lark - Lark API äº¤äº’å·¥å…·
          - ğŸ“š çŸ¥è¯†ç©ºé—´ç®¡ç†å’Œæ–‡æ¡£æ“ä½œ
          - ğŸ“ æ–‡æ¡£åˆ›å»ºã€ç¼–è¾‘ã€è½¬æ¢
          - ğŸ’¬ æ¶ˆæ¯æœåŠ¡ï¼ˆå‘é€æ¶ˆæ¯ã€æœç´¢èŠå¤©ï¼‰
          - ğŸ“ æ–‡ä»¶ç®¡ç†ï¼ˆä¸Šä¼ ã€å¯¼å…¥ï¼‰

          ### ark - Ark AI å›¾ç‰‡ç”Ÿæˆå·¥å…·
          - ğŸ¨ AI å›¾ç‰‡ç”Ÿæˆï¼ˆè‡ªç„¶è¯­è¨€æè¿°ç”Ÿæˆé«˜è´¨é‡å›¾ç‰‡ï¼‰
          - ğŸŒ SSE æµå¼å“åº”ï¼ˆå®æ—¶è·å–å›¾ç‰‡ç”Ÿæˆè¿›åº¦ï¼‰
          - ğŸ” JWT è®¤è¯ï¼ˆè‡ªåŠ¨è·å–å’Œåˆ·æ–°è®¤è¯ä»¤ç‰Œï¼Œæ”¯æŒä»¤ç‰Œç¼“å­˜ï¼‰

          ## å®‰è£…æ–¹å¼

          ### è‡ªåŠ¨å®‰è£…ï¼ˆæ¨èï¼‰

          #### Unix/Linux/macOS
          ```bash
          curl -sSL https://raw.githubusercontent.com/DreamCats/byted-cli-scripts/main/install.sh | bash
          ```

          #### Windows
          ```powershell
          iwr -useb https://raw.githubusercontent.com/DreamCats/byted-cli-scripts/main/install.ps1 | iex
          ```

          ## è¯¦ç»†æ–‡æ¡£

          è¯¦ç»†ä½¿ç”¨æ–‡æ¡£è¯·è®¿é—® [byted-cli-scripts ä»“åº“](https://github.com/DreamCats/byted-cli-scripts)
          EOF

          # æ›¿æ¢ç‰ˆæœ¬å·
          sed -i "s/\$VERSION/$VERSION/g" release_notes.md

          echo "notes<<EOF" >> $GITHUB_OUTPUT
          cat release_notes.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.release_info.outputs.tag }}
          name: Release ${{ steps.release_info.outputs.tag }}
          body: ${{ steps.release_notes.outputs.notes }}
          files: release/*
          draft: false
          prerelease: false
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "âœ… å…¬å¼€ä»“åº“ Release åˆ›å»ºæˆåŠŸ!"
          echo "ğŸ”— Release: https://github.com/DreamCats/byted-cli-scripts/releases/tag/${{ steps.release_info.outputs.tag }}"
          echo "ğŸ“¦ å®‰è£…å‘½ä»¤: curl -sSL https://raw.githubusercontent.com/DreamCats/byted-cli-scripts/main/install.sh | bash"
